name: Deploy to Firebase App Distribution

on:
  pull_request:
    branches: [master]
  push:
    branches: [master]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "19.0.1"
          cache: "yarn"
      - name: Install dependencies
        run: yarn install

      - name: Decode Keystore
        id: decode_keystore
        uses: timheuer/base64-to-file@v1
        with:
          fileName: 'android/app/dsound.keystore'
          encodedString: ${{ secrets.SIGNINGKEYBASE64 }}

      - name: check
        run: |
          cd android/app
          pwd
          ls

      - name: Build APK
        id: build
        run: |
          cd android
          ./gradlew assembleRelease

      # - name: Sign APK
      #   id: sign_apk
      #   uses: r0adkll/sign-android-release@v1
      #   with:
      #     releaseDirectory: ./android/app/build/outputs/apk/release
      #     signingKeyBase64: ${{ secrets.SIGNINGKEYBASE64 }}
      #     alias: ${{ secrets.MYAPP_UPLOAD_KEY_ALIAS }}
      #     keyStorePassword: ${{ secrets.MYAPP_UPLOAD_STORE_PASSWORD }}
      #     keyPassword: ${{ secrets.MYAPP_UPLOAD_KEY_PASSWORD }}

      - name: upload artifact to Firebase App Distribution
        uses: wzieba/Firebase-Distribution-Github-Action@v1
        with:
          appId: ${{secrets.FIREBASE_APP_ID}}
          serviceCredentialsFileContent: ${{ secrets.CREDENTIAL_FILE_CONTENT }}
          file: ./android/app/build/outputs/apk/release/app-release.apk
